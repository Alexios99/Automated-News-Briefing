{% extends 'base.html' %}
{% block title %}View Briefings{% endblock %}
{% block content %}
<h2 class="mb-4">Past Briefings</h2>
<div class="mb-3">
  <input type="text" class="form-control" id="briefingSearch" placeholder="Search by date or keyword...">
</div>
{% if briefings_by_date %}
  <div id="briefings-list">
    {% for date, info in briefings_by_date.items() %}
      <div class="card mb-3 briefing-group">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><strong>{{ date }}</strong> <small class="text-muted">({{ info.datetime.strftime('%A, %d %B %Y') }})</small></span>
        </div>
        <div class="card-body">
          <div class="row align-items-center">
            {% for fmt, fname in info.files.items() %}
              <div class="col-md-4 mb-2 briefing-file" data-filename="{{ fname }}">
                <div class="d-flex align-items-center">
                  <span class="me-2">
                    {% if fmt == 'pdf' %}<i class="bi bi-file-earmark-pdf text-danger"></i>{% endif %}
                    {% if fmt == 'html' %}<i class="bi bi-file-earmark-code text-primary"></i>{% endif %}
                    {% if fmt == 'md' %}<i class="bi bi-file-earmark-text text-secondary"></i>{% endif %}
                  </span>
                  <span class="me-2">{{ fmt|upper }}</span>
                  <a href="{{ url_for('main.view_file', filename=fname) }}" class="btn btn-sm btn-outline-primary ms-2" target="_blank" title="View"><i class="bi bi-eye"></i></a>
                  <a href="{{ url_for('main.download_file', filename=fname) }}" class="btn btn-sm btn-outline-success ms-2" title="Download"><i class="bi bi-download"></i></a>
                  {% if fmt in ['md', 'html'] %}
                  <button class="btn btn-sm btn-outline-info ms-2 preview-btn" data-filename="{{ fname }}" data-bs-toggle="modal" data-bs-target="#previewModal" title="Preview"><i class="bi bi-search"></i></button>
                  {% endif %}
                  <button class="btn btn-sm btn-outline-danger ms-2 delete-btn" data-filename="{{ fname }}" data-bs-toggle="modal" data-bs-target="#deleteModal" title="Delete"><i class="bi bi-trash"></i></button>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="alert alert-info">No briefings found.</div>
{% endif %}

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="previewModalLabel">Briefing Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="previewContent">
        <div class="text-center text-muted">Loading preview...</div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Delete Briefing</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this briefing file?
        <div class="fw-bold mt-2" id="deleteFilename"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<!-- Custom JS for search/filter, preview, delete (to be added) -->
<script>
// Instant search/filter
const searchInput = document.getElementById('briefingSearch');
searchInput.addEventListener('input', function() {
  const query = this.value.toLowerCase();
  document.querySelectorAll('.briefing-group').forEach(group => {
    const groupText = group.textContent.toLowerCase();
    group.style.display = groupText.includes(query) ? '' : 'none';
  });
});

// Preview modal AJAX
let previewModal = document.getElementById('previewModal');
document.querySelectorAll('.preview-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const filename = this.getAttribute('data-filename');
    const previewContent = document.getElementById('previewContent');
    previewContent.innerHTML = '<div class="text-center text-muted">Loading preview...</div>';
    fetch(`/preview/${encodeURIComponent(filename)}`)
      .then(res => res.json())
      .then(data => {
        if (data.preview) {
          // Render as <pre> for markdown, or as HTML for .html
          if (filename.endsWith('.md')) {
            previewContent.innerHTML = `<pre>${escapeHtml(data.preview)}</pre>`;
          } else {
            previewContent.innerHTML = `<div style="max-height:400px;overflow:auto">${data.preview}</div>`;
          }
        } else {
          previewContent.innerHTML = `<div class="alert alert-danger">${data.error || 'Error loading preview.'}</div>`;
        }
      })
      .catch(() => {
        previewContent.innerHTML = '<div class="alert alert-danger">Error loading preview.</div>';
      });
  });
});

// Escape HTML for safe <pre> rendering
function escapeHtml(text) {
  return text.replace(/[&<>"']/g, function(m) {
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]);
  });
}

// Delete modal logic
let deleteFilename = '';
document.querySelectorAll('.delete-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    deleteFilename = this.getAttribute('data-filename');
    document.getElementById('deleteFilename').textContent = deleteFilename;
  });
});

document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
  if (!deleteFilename) return;
  fetch(`/delete/${encodeURIComponent(deleteFilename)}`, {
    method: 'POST',
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        // Remove the file's card from the UI
        document.querySelectorAll(`[data-filename='${CSS.escape(deleteFilename)}']`).forEach(el => {
          el.parentElement.removeChild(el);
        });
        // If group is empty, remove group
        document.querySelectorAll('.briefing-group').forEach(group => {
          if (group.querySelectorAll('.briefing-file').length === 0) {
            group.parentElement.removeChild(group);
          }
        });
        // Hide modal
        var deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
        deleteModal.hide();
      } else {
        alert(data.error || 'Error deleting file.');
      }
    })
    .catch(() => {
      alert('Error deleting file.');
    });
});
</script>
{% endblock %} 